# 개발 완료 이력 - 2025-12-24

> 뉴스 스크립트 SSE 스트리밍 구현, Thinking UI 개선, **Minimal UI Refactoring**, Anthropic 스타일 색상 테마 적용

---

## Phase 3: AI 서비스 구현 (계속)

### 3-2. 뉴스 스크립트 스트리밍 기능 구현

- [x] Backend: 스트리밍용 프롬프트 추가 (`news_script_stream.md`)
- [x] Backend: `AudioService`에 `llm_streaming` 인스턴스 추가
- [x] Backend: `generate_script_stream()` 메서드 구현 (AsyncGenerator)
- [x] Backend: `parse_stream_result()` 정적 메서드 구현 (Plain Text → NewsScript 파싱)
- [x] Backend: `/api/v1/audio/script/stream` SSE 엔드포인트 추가
- [x] Frontend: `generateScriptStream()`, `generateScriptStreamWithCallbacks()` 함수 추가
- [x] Frontend: `ScriptStreamingState` 타입 및 상태 관리 추가
- [x] Frontend: `AudioPlayerCard` 스트리밍 UI 구현 (Thinking + Script Collapsible)

**수정된 파일:**

| 파일 | 변경 내용 |
|------|----------|
| `backend/prompts/v1/news_script_stream.md` | 스트리밍용 Plain Text 프롬프트 (신규) |
| `backend/app/services/audio.py` | `llm_streaming`, `generate_script_stream()`, `parse_stream_result()` 추가 |
| `backend/app/api/v1/audio.py` | `/script/stream` SSE 엔드포인트 추가 |
| `frontend/lib/api.ts` | `ScriptStreamEvent`, `generateScriptStream()`, `generateScriptStreamWithCallbacks()` 추가 |
| `frontend/app/page.tsx` | `ScriptStreamingState` 상태, `scriptAbortControllerRef` 추가, 스트리밍 호출로 변경 |
| `frontend/components/content-panel.tsx` | `scriptStreaming` prop 추가 |
| `frontend/components/intelligence-panel.tsx` | `scriptStreaming` prop 전달 |
| `frontend/components/audio-player-card.tsx` | 스트리밍 UI 전면 개편 (Thinking + Script Collapsible) |

**핵심 구현 코드:**

```python
# backend/app/services/audio.py
async def generate_script_stream(
    self,
    content: str,
    original_content: str | None = None,
) -> AsyncGenerator[tuple[str, str], None]:
    """
    스트리밍으로 뉴스 스크립트를 생성합니다 (Thinking 포함).
    
    Yields:
        (event_type, text) 튜플
        - event_type: "thinking" | "content"
        - text: 스트리밍된 텍스트 청크
    """
    # ... 구현
```

```typescript
// frontend/lib/api.ts
export function generateScriptStreamWithCallbacks(
  request: GenerateScriptRequest,
  callbacks: ScriptStreamCallbacks
): AbortController {
  // summarizeStreamWithCallbacks()와 동일한 패턴
}
```

**동작 흐름:**

```
[크롤링 완료]
     │
     ├──────────────────────┬───────────────────────────┐
     │                      │                           │
     ▼                      ▼                           │
[요약 스트리밍]       [스크립트 스트리밍]               │
(SSE: thinking → content)  (SSE: thinking → content)    │
     │                      │                           │
     ▼                      ▼                           │
[InsightCard UI]      [AudioPlayerCard UI]              │
- Thinking Collapsible   - Thinking Collapsible         │
- Bullet Points 스트리밍  - Script 문단 스트리밍        │
     │                      │                           │
     └──────────────────────┴───────────────────────────┘
                            │
                            ▼
                   [병렬 처리 완료]
```

---

### 3-3. NewsScript Validation 완화

- [x] `output_schemas/audio.py` validation 제한 완화

**수정된 파일:**

| 파일 | 변경 내용 |
|------|----------|
| `backend/output_schemas/audio.py` | validation 제한 완화 (스트리밍 Plain Text 파싱 대응) |

**변경 내용:**

| 필드 | 변경 전 | 변경 후 |
|------|--------|---------|
| `paragraphs` | 8~12개 | 1~20개 |
| `estimated_duration_sec` | 150~210초 | 30~600초 |
| `total_characters` | 800~1200자 | 100~5000자 |

**이유:** 스트리밍에서 LLM이 Plain Text로 출력할 때 정확한 길이를 맞추기 어려움. 프롬프트에서 목표 분량을 안내하고, validation은 유연하게 허용.

---

### 3-4. Thinking 텍스트 클리닝

- [x] `cleanThinkingText()` 유틸리티 함수 추가
- [x] `InsightCard`, `AudioPlayerCard` 모두에 적용

**수정된 파일:**

| 파일 | 변경 내용 |
|------|----------|
| `frontend/components/insight-card.tsx` | `cleanThinkingText()` 함수 추가 및 적용 |
| `frontend/components/audio-player-card.tsx` | `cleanThinkingText()` 함수 추가 및 적용 |

**핵심 구현 코드:**

```typescript
/**
 * Thinking 텍스트에서 escaped newlines를 실제 줄바꿈으로 변환하고 정리합니다.
 */
function cleanThinkingText(text: string): string {
  if (!text) return "";
  
  // 문자열로 들어온 \n\n을 실제 줄바꿈으로 변환
  let cleaned = text.replace(/\\n\\n/g, "\n\n");
  cleaned = cleaned.replace(/\\n/g, "\n");
  
  // 연속된 빈 줄을 하나로 정리
  cleaned = cleaned.replace(/\n{3,}/g, "\n\n");
  
  return cleaned.trim();
}
```

**Before:**
```
Composing a Script\n\n\n\nI'm currently focused on the structure...
```

**After:**
```
Composing a Script

I'm currently focused on the structure...
```

---

### 3-5. 완료 상태에서 전체 스크립트 표시

- [x] `AudioPlayerCard` 완료 상태 UI 개선
- [x] Collapsible로 전체 스크립트 paragraphs 표시
- [x] Markdown 렌더링 적용

**수정된 파일:**

| 파일 | 변경 내용 |
|------|----------|
| `frontend/components/audio-player-card.tsx` | 완료 상태 Collapsible UI 추가 |

**UI 구조:**

```
┌────────────────────────────────────────────────────────┐
│ 📻 뉴스 리포팅 (Audio)                                 │
├────────────────────────────────────────────────────────┤
│                                                        │
│ ▸ AI가 바꾸는 미래의 일자리 (클릭하면 확장)           │
│                                                        │
│ [확장 시]                                              │
│ ▾ AI가 바꾸는 미래의 일자리                          │
│   ┌──────────────────────────────────────────────┐    │
│   │ 첫 번째 문단 (Markdown 렌더링)                │    │
│   │ 두 번째 문단                                  │    │
│   │ ...                                          │    │
│   │ ─────────────────────────────────────────── │    │
│   │ 📊 예상 4분 44초 | 1420자 | 13개 문단        │    │
│   └──────────────────────────────────────────────┘    │
│                                                        │
│ ✅ 대본 생성 완료                                      │
│ 🔊 TTS 음성 합성 기능은 곧 추가될 예정입니다.         │
└────────────────────────────────────────────────────────┘
```

---

## 설계 결정 기록 (ADR)

### ADR-013: 뉴스 스크립트 스트리밍 구현 방식

| 항목 | 내용 |
|------|------|
| **결정** | 요약 스트리밍과 동일한 패턴으로 뉴스 스크립트 스트리밍 구현 (SSE + Plain Text + 클라이언트 파싱) |
| **이유** | 1) 일관된 UX 제공 (Thinking + Content 스트리밍), 2) 코드 재사용성 극대화, 3) 병렬 처리 유지 |
| **대안** | 1) Structured Output 유지 (스트리밍 불가), 2) WebSocket (오버엔지니어링) |
| **결과** | 요약과 스크립트가 동일한 UX 패턴으로 병렬 스트리밍, Thinking UI 통일 |

### ADR-014: NewsScript Validation 완화

| 항목 | 내용 |
|------|------|
| **결정** | NewsScript validation 제한을 유연하게 완화 (strict → flexible) |
| **이유** | Plain Text 스트리밍에서 LLM 출력 길이를 정확히 제어하기 어려움 |
| **대안** | 1) Structured Output 사용 (스트리밍 불가), 2) 후처리로 강제 조정 (품질 저하) |
| **결과** | 프롬프트에서 목표 분량 안내, validation은 유연하게 허용하여 에러 방지 |

---

## Frontend: Minimal UI Refactoring

### 4-1. 레이아웃 구조 변경

- [x] 2컬럼 그리드 → 싱글 컬럼 레이아웃 (max-width: 680px)
- [x] Card 컴포넌트 제거 → 타이포그래피와 여백으로 시각적 계층 표현
- [x] Header + InputArea 통합 → 컴팩트한 상단 바
- [x] IntelligencePanel 제거 → ContentPanel에서 직접 컴포넌트 사용

**수정된 파일:**

| 파일 | 변경 내용 |
|------|----------|
| `frontend/app/globals.css` | 미니멀 스타일 변수 및 유틸리티 추가 |
| `frontend/app/page.tsx` | InputArea 제거, Header에 props 전달, WelcomeInput 추가 |
| `frontend/components/content-panel.tsx` | 싱글 컬럼 레이아웃, IntelligencePanel 제거 |
| `frontend/components/header.tsx` | InputArea 통합, 다크모드 토글 추가 |
| `frontend/components/source-panel.tsx` | Card 제거, 접기/펼치기 메타 정보로 변경 |
| `frontend/components/insight-card.tsx` | Card 제거, 타이포그래피 기반 섹션으로 변경 |
| `frontend/components/audio-player-card.tsx` | Card 제거, 미니멀 플레이어로 심플화 |
| `frontend/components/welcome-input.tsx` | 신규 - 중앙 배치 입력 컴포넌트 |
| `frontend/components/input-area.tsx` | **삭제** (Header에 통합) |
| `frontend/components/intelligence-panel.tsx` | **삭제** (ContentPanel에서 직접 사용) |

**UI 구조 변경:**

```
[Before - Card Heavy]                    [After - Content First]
┌──────────────────────────┐             ┌──────────────────────────┐
│     큰 Hero 영역          │             │ Read-For-Me  [URL입력]   │
│  [URL 입력창] [실행]      │             ├──────────────────────────┤
├─────────┬────────────────┤             │                          │
│ ╭─────╮ │ ╭────────────╮ │             │ GeekNews · 2024.12.24    │
│ │Card │ │ │ Card       │ │             │ ─────────────────────    │
│ │원문 │ │ │ 요약       │ │     =>      │ # 기사 제목              │
│ ╰─────╯ │ ╰────────────╯ │             │                          │
│         │ ╭────────────╮ │             │ ✨ AI 3줄 요약           │
│         │ │ Card       │ │             │ • 첫 번째 요약           │
│         │ │ 오디오     │ │             │ • 두 번째 요약           │
│         │ ╰────────────╯ │             │                          │
└─────────┴────────────────┘             │ 🎧 오디오 리포팅         │
                                         │ ▶ ━━━○━━━━━ 2:34         │
                                         └──────────────────────────┘
```

---

### 4-2. URL 입력창 동적 배치

- [x] 초기 상태(idle): 화면 중앙에 WelcomeInput 표시
- [x] 처리 시작 후: Header로 입력창 이동
- [x] Header에 `showInput` prop 추가

**WelcomeInput 컴포넌트:**

```typescript
// 초기 상태에서 중앙에 표시되는 입력 컴포넌트
export function WelcomeInput({ onSubmit, isLoading }: WelcomeInputProps) {
  return (
    <div className="flex-1 flex items-center justify-center">
      <div className="w-full max-w-xl space-y-8">
        <div className="text-center space-y-3">
          <h2>바쁜 당신을 위한 뉴스 리포팅</h2>
          <p>URL만 넣으면 요약과 오디오를 생성합니다</p>
        </div>
        <form>{/* 입력창 */}</form>
      </div>
    </div>
  );
}
```

---

### 4-3. Anthropic 스타일 색상 테마

- [x] 크림/베이지 배경 (따뜻한 톤)
- [x] 코랄/오렌지 Primary 색상
- [x] 다크모드 토글 추가 (Header)
- [x] ThemeProvider 설정 (layout.tsx)

**색상 변수:**

| 요소 | Light Mode | Dark Mode |
|------|------------|-----------|
| 배경 | 크림/아이보리 | 따뜻한 다크 브라운 |
| 텍스트 | 진한 브라운 | 크림색 |
| Primary | 코랄/오렌지 | 밝은 코랄 |
| Muted | 베이지/탄 | 따뜻한 회색 |

---

### 4-4. 섹션 제목 스타일링

- [x] 악센트 바 제거 (미니멀하지 않음)
- [x] 아이콘 + 폰트 스타일로 구분
  - AI 3줄 요약: ✨ Sparkles 아이콘
  - 오디오 리포팅: 🎧 Headphones 아이콘

**CSS:**

```css
.section-header {
  @apply flex items-center gap-2 text-lg font-semibold text-foreground tracking-tight;
}
```

---

### 4-5. 스트리밍 표시 개선

- [x] 텍스트 끝 커서(보라색 바) 제거
- [x] Thinking 제목에 shimmer 효과 (좌→우 gradient)
- [x] 스피너 아이콘 (Loader2 + animate-spin)

**Shimmer CSS:**

```css
@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.shimmer-text {
  background: linear-gradient(
    90deg,
    var(--muted-foreground) 0%,
    var(--muted-foreground) 35%,
    var(--foreground) 50%,
    var(--muted-foreground) 65%,
    var(--muted-foreground) 100%
  );
  background-size: 200% 100%;
  background-clip: text;
  color: transparent;
  animation: shimmer 3.5s linear infinite;
}
```

---

### 4-6. 기타 개선

- [x] 원문 미리보기에 말줄임표(...) 추가
- [x] layout.tsx에 ThemeProvider 추가
- [x] 다크모드 토글 (Header)

---

## 설계 결정 기록 (ADR) - 추가

### ADR-015: Minimal UI Refactoring

| 항목 | 내용 |
|------|------|
| **결정** | Card 기반 UI를 타이포그래피/여백 기반 미니멀 UI로 전환 |
| **이유** | 1) 콘텐츠 중심 UX 개선, 2) 시각적 노이즈 감소, 3) 읽기 최적화 |
| **대안** | 1) Card 유지하되 스타일만 변경, 2) 완전히 새로운 디자인 시스템 |
| **결과** | 싱글 컬럼 680px 레이아웃, Card 제거, 타이포그래피로 계층 구분 |

### ADR-016: URL 입력창 동적 배치

| 항목 | 내용 |
|------|------|
| **결정** | idle 상태에서는 중앙에 크게, 처리 시작 후 Header로 이동 |
| **이유** | 1) 첫 인상에서 주요 액션(URL 입력) 강조, 2) 처리 중에는 콘텐츠에 집중 |
| **대안** | 1) 항상 Header에 배치, 2) 플로팅 입력창 |
| **결과** | WelcomeInput 컴포넌트 신규 생성, Header에 showInput prop 추가 |

### ADR-017: Anthropic 스타일 색상 테마

| 항목 | 내용 |
|------|------|
| **결정** | Anthropic 웹사이트 스타일의 따뜻한 크림/코랄 색상 테마 적용 |
| **이유** | 1) 차가운 파란색 대신 따뜻한 느낌, 2) 읽기 편안한 배경색, 3) 고급스러운 인상 |
| **대안** | 1) 기존 파란색 테마 유지, 2) 다른 색상 팔레트 |
| **결과** | globals.css 색상 변수 전면 수정, 다크모드도 따뜻한 톤 유지 |

---

## 다음 작업

- [ ] TTS 음성 합성 (Step 2) - OpenAI TTS API 연동
- [ ] 오디오 파일 생성 및 저장
- [ ] Frontend AudioPlayerCard에서 오디오 재생 기능 구현

