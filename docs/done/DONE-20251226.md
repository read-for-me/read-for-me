# ê°œë°œ ì™„ë£Œ ì´ë ¥ - 2025-12-26

> Apidog ì—°ë™ ì¤€ë¹„: OpenAPI ë©”íƒ€ë°ì´í„° ê°œì„ , CI/CD ìë™ ë™ê¸°í™” ì›Œí¬í”Œë¡œìš° êµ¬ì¶•, UTF-8 ì¸ì½”ë”© ë¬¸ì œ í•´ê²°
> **Phoenix Tracing í†µí•©**: LLM í˜¸ì¶œ ì¶”ì ì„ ìœ„í•œ Arize Phoenix ë¡œì»¬ í™˜ê²½ êµ¬ì¶• ì™„ë£Œ
> **GCS Storage ë§ˆì´ê·¸ë ˆì´ì…˜**: í™˜ê²½ë³€ìˆ˜ë¡œ ì „í™˜ ê°€ëŠ¥í•œ Storage ì¶”ìƒí™” ë ˆì´ì–´ êµ¬í˜„
> **ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ**: Cloud Run (Backend + Phoenix) + Vercel (Frontend) ë°°í¬

---

## API ë¬¸ì„œí™” & DevOps ê°œì„ 

### OpenAPI ë©”íƒ€ë°ì´í„° ê°œì„ 

- [x] FastAPI ì•±ì— ìƒì„¸ description ì¶”ê°€ (README ìŠ¤íƒ€ì¼)
- [x] API íƒœê·¸ë³„ ì„¤ëª… ì¶”ê°€ (`crawl`, `summarize`, `audio`)
- [x] contact ë° license_info ë©”íƒ€ë°ì´í„° ì¶”ê°€
- [x] UTF-8 ì¸ì½”ë”©ëœ ì»¤ìŠ¤í…€ OpenAPI ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

**ìˆ˜ì •ëœ íŒŒì¼:**

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|----------|
| `backend/app/main.py` | OpenAPI ë©”íƒ€ë°ì´í„° ê°œì„ , ì»¤ìŠ¤í…€ `/api/v1/openapi.json` ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ |
| `backend/app/core/config.py` | `APIDOG_API_KEY`, `APIDOG_PROJECT_ID` í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€ |

**í•µì‹¬ êµ¬í˜„ ì½”ë“œ:**

```python
# main.py - OpenAPI ë©”íƒ€ë°ì´í„° ê°œì„ 
def get_application() -> FastAPI:
    _app = FastAPI(
        title=settings.PROJECT_NAME,
        version=settings.VERSION,
        description="""
## Read-For-Me API

URL í¬ë¡¤ë§, AI ìš”ì•½, ë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° TTS ìŒì„± í•©ì„±ì„ ì œê³µí•˜ëŠ” ë°±ì—”ë“œ APIì…ë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥
- **ğŸ” Crawl**: URLì„ ì…ë ¥ë°›ì•„ ì›¹ í˜ì´ì§€ ì½˜í…ì¸ ë¥¼ í¬ë¡¤ë§í•˜ê³  ì •ì œ
- **ğŸ“ Summarize**: AI ê¸°ë°˜ ì½˜í…ì¸  ìš”ì•½ (Gemini)
- **ğŸ™ï¸ Audio**: ë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° TTS ìŒì„± í•©ì„± (OpenAI)
        """,
        openapi_url=None,  # ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
        openapi_tags=[
            {"name": "crawl", "description": "URL í¬ë¡¤ë§ ë° ì½˜í…ì¸  ì¶”ì¶œ API"},
            {"name": "summarize", "description": "AI ê¸°ë°˜ ì½˜í…ì¸  ìš”ì•½ API (Gemini)"},
            {"name": "audio", "description": "ë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° TTS ìŒì„± í•©ì„± API (OpenAI)"},
        ],
        contact={"name": "Read-For-Me Team", "url": "https://github.com/your-repo/read-for-me"},
        license_info={"name": "MIT License", "url": "https://opensource.org/licenses/MIT"},
    )
    # ...
```

```python
# main.py - UTF-8 ì¸ì½”ë”© ì»¤ìŠ¤í…€ OpenAPI ì—”ë“œí¬ì¸íŠ¸
@app.get(f"{settings.API_V1_STR}/openapi.json", include_in_schema=False)
async def custom_openapi():
    """
    UTF-8 ì¸ì½”ë”©ëœ OpenAPI ìŠ¤í™ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
    ê¸°ë³¸ FastAPI OpenAPI ì—”ë“œí¬ì¸íŠ¸ì˜ í•œê¸€ ê¹¨ì§ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
    """
    openapi_schema = app.openapi()
    return Response(
        content=json.dumps(openapi_schema, ensure_ascii=False, indent=2),
        media_type="application/json; charset=utf-8",
    )
```

---

### Apidog CI/CD ìë™ ë™ê¸°í™” ì›Œí¬í”Œë¡œìš°

- [x] GitHub Actions ì›Œí¬í”Œë¡œìš° ìƒì„± (`.github/workflows/apidog-sync.yml`)
- [x] OpenAPI ìŠ¤í™ ìë™ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
- [x] Apidog API ì—…ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸
- [x] ìˆ˜ë™ ì‹¤í–‰ (`workflow_dispatch`) ì§€ì›

**ìƒì„±ëœ íŒŒì¼:**

| íŒŒì¼ | ì„¤ëª… |
|------|------|
| `.github/workflows/apidog-sync.yml` | Apidog OpenAPI ìë™ ë™ê¸°í™” ì›Œí¬í”Œë¡œìš° |

**ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°:**

| íŠ¸ë¦¬ê±° | ì¡°ê±´ |
|--------|------|
| Push | `main` ë¸Œëœì¹˜, `backend/**` ê²½ë¡œ ë³€ê²½ ì‹œ |
| ìˆ˜ë™ | `workflow_dispatch`ë¡œ ì§ì ‘ ì‹¤í–‰ ê°€ëŠ¥ |

**í•„ìš”í•œ GitHub Secrets:**

| Secret | ì„¤ëª… |
|--------|------|
| `APIDOG_API_KEY` | Apidog API í‚¤ |
| `APIDOG_PROJECT_ID` | Apidog í”„ë¡œì íŠ¸ ID |

**í•µì‹¬ ì›Œí¬í”Œë¡œìš° ë‹¨ê³„:**

```yaml
# .github/workflows/apidog-sync.yml
- name: Generate OpenAPI spec
  run: |
    uv run python -c "
    import json
    from app.main import app
    openapi_schema = app.openapi()
    with open('../openapi.json', 'w', encoding='utf-8') as f:
        json.dump(openapi_schema, f, ensure_ascii=False, indent=2)
    "

- name: Upload OpenAPI spec to Apidog
  run: |
    curl -X POST "https://api.apidog.com/v1/projects/${APIDOG_PROJECT_ID}/import-openapi" \
      -H "Authorization: Bearer ${APIDOG_API_KEY}" \
      -H "Content-Type: application/json" \
      -d @openapi.json --fail-with-body
```

---

### config.py í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€

- [x] `APIDOG_API_KEY` í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
- [x] `APIDOG_PROJECT_ID` í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€

**ìˆ˜ì •ëœ ì½”ë“œ:**

```python
# config.py
class Settings(BaseSettings):
    # ... ê¸°ì¡´ ì„¤ì •ë“¤ ...
    
    # ===== Apidog ì„¤ì • (CI/CD ì—°ë™ìš©) =====
    APIDOG_API_KEY: str = ""  # Apidog API í‚¤
    APIDOG_PROJECT_ID: str = ""  # Apidog í”„ë¡œì íŠ¸ ID
```

---

## ì„¤ê³„ ê²°ì • ê¸°ë¡ (ADR)

### ADR-025: OpenAPI ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ê²°ì •** | FastAPI ê¸°ë³¸ OpenAPI ì—”ë“œí¬ì¸íŠ¸ ëŒ€ì‹  ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ |
| **ì´ìœ ** | ê¸°ë³¸ FastAPIì˜ `json.dumps()`ê°€ `ensure_ascii=True`ë¡œ ë™ì‘í•˜ì—¬ í•œê¸€ì´ Unicode escape ì²˜ë¦¬ë¨ |
| **ëŒ€ì•ˆ** | 1) ì™¸ë¶€ ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©, 2) Response í›„ì²˜ë¦¬ |
| **ê²°ê³¼** | `ensure_ascii=False`ë¡œ í•œê¸€ì´ ì •ìƒ í‘œì‹œ, Apidog Import ì‹œ ë¬¸ì„œ ê°€ë…ì„± í–¥ìƒ |

### ADR-026: Apidog CI/CD ìë™ ë™ê¸°í™”

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ê²°ì •** | GitHub Actionsë¡œ `backend/**` ë³€ê²½ ì‹œ ìë™ OpenAPI ë™ê¸°í™” |
| **ì´ìœ ** | API ë³€ê²½ ì‹œ ìˆ˜ë™ ì—…ë¡œë“œ ë²ˆê±°ë¡œì›€, ë¬¸ì„œì™€ ì½”ë“œ ë¶ˆì¼ì¹˜ ë°©ì§€ |
| **ëŒ€ì•ˆ** | 1) ìˆ˜ë™ ì—…ë¡œë“œ, 2) Git Hook, 3) ë³„ë„ ìŠ¤í¬ë¦½íŠ¸ |
| **ê²°ê³¼** | main ë¸Œëœì¹˜ push ì‹œ ìë™ ë™ê¸°í™”, ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥ |

---

## ë™ì‘ íë¦„

### OpenAPI ìŠ¤í™ ìƒì„± ë° Apidog ë™ê¸°í™”

```
[Backend ì½”ë“œ ë³€ê²½]
       â”‚
       â–¼
[GitHub Push to main]
       â”‚
       â–¼
[GitHub Actions íŠ¸ë¦¬ê±°]
       â”‚
       â”œâ”€â–¶ [uv sync] ì˜ì¡´ì„± ì„¤ì¹˜
       â”‚
       â”œâ”€â–¶ [Python] app.openapi() í˜¸ì¶œ
       â”‚         â”‚
       â”‚         â–¼
       â”‚   [openapi.json ìƒì„±]
       â”‚         â”‚
       â–¼         â–¼
[curl POST] â”€â”€â–¶ [Apidog API]
                    â”‚
                    â–¼
              [API ë¬¸ì„œ ë™ê¸°í™” ì™„ë£Œ]
```

### ë¡œì»¬ OpenAPI ìŠ¤í™ ì¡°íšŒ

```
[ë¸Œë¼ìš°ì €/curl]
       â”‚
       â–¼
[GET /api/v1/openapi.json]
       â”‚
       â–¼
[custom_openapi() í•¸ë“¤ëŸ¬]
       â”‚
       â”œâ”€â–¶ app.openapi() í˜¸ì¶œ
       â”‚
       â”œâ”€â–¶ json.dumps(ensure_ascii=False)
       â”‚
       â–¼
[UTF-8 ì¸ì½”ë”©ëœ JSON ì‘ë‹µ]
```

---

---

## Phase 6: Phoenix Tracing í†µí•©

### 6-1. Phoenix ë¡œì»¬ í™˜ê²½ êµ¬ì¶•

- [x] Docker Composeë¡œ Phoenix ì»¨í…Œì´ë„ˆ ì„¤ì •
- [x] `arize-phoenix`, `openinference-instrumentation-langchain`, `opentelemetry-*` ì˜ì¡´ì„± ì¶”ê°€
- [x] `tracing.py` ëª¨ë“ˆ ìƒì„± - Phoenix íŠ¸ë ˆì´ì‹± ì´ˆê¸°í™”
- [x] `main.py`ì— `init_tracing()` í˜¸ì¶œ ì¶”ê°€
- [x] Phoenix UI (`http://localhost:6006`)ì—ì„œ íŠ¸ë ˆì´ì‹± í™•ì¸ ì™„ë£Œ

### 6-2. ëª¨ë‹ˆí„°ë§ í•­ëª© (Phoenix UI ê¸°ë³¸ ì œê³µ)

- [x] **ì…ë ¥/ì¶œë ¥ ì¶”ì **: Traces íƒ­ì—ì„œ í”„ë¡¬í”„íŠ¸ ë° LLM ì‘ë‹µ ê¸°ë¡ í™•ì¸
- [x] **LLM Chain Trace**: Span ìƒì„¸ ë³´ê¸°ì—ì„œ í˜¸ì¶œ ì²´ì¸ ì‹œê°í™”
- [x] **ë¹„ìš© ì¶”ì **: Token Usage ë©”íŠ¸ë¦­ìœ¼ë¡œ í† í° ì‚¬ìš©ëŸ‰ í™•ì¸
- [x] **ì§€ì—° ì‹œê°„**: Latency ë©”íŠ¸ë¦­ìœ¼ë¡œ ì‘ë‹µ ì‹œê°„ ëª¨ë‹ˆí„°ë§

### 6-4. ëŒ€ì‹œë³´ë“œ (Phoenix UI ê¸°ë³¸ ì œê³µ)

- [x] Phoenix UI (`http://localhost:6006`)ì—ì„œ ì‹œê°í™” ì œê³µ
  - Traces íƒ­: ì¼ë³„/ì£¼ë³„ API í˜¸ì¶œ ìˆ˜
  - Latency ë©”íŠ¸ë¦­: í‰ê·  ì‘ë‹µ ì‹œê°„
  - Token Usage: í† í° ì‚¬ìš©ëŸ‰ ë° ë¹„ìš©
  - Status í•„í„°: ì—ëŸ¬ìœ¨ í™•ì¸

**ìƒì„±ëœ íŒŒì¼:**

| íŒŒì¼ | ì„¤ëª… |
|------|------|
| `docker-compose.yml` | Phoenix ì»¨í…Œì´ë„ˆ ì„¤ì • (ports: 6006, 4317) |
| `backend/app/core/tracing.py` | Phoenix íŠ¸ë ˆì´ì‹± ì´ˆê¸°í™” ëª¨ë“ˆ |

**ìˆ˜ì •ëœ íŒŒì¼:**

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|----------|
| `backend/pyproject.toml` | Phoenix/OpenTelemetry ì˜ì¡´ì„± 5ê°œ ì¶”ê°€ |
| `backend/app/core/config.py` | `PHOENIX_COLLECTOR_ENDPOINT`, `PHOENIX_PROJECT_NAME`, `PHOENIX_ENABLED` í™˜ê²½ë³€ìˆ˜ ì¶”ê°€ |
| `backend/app/main.py` | `init_tracing()` import ë° í˜¸ì¶œ ì¶”ê°€ |

**í•µì‹¬ êµ¬í˜„ ì½”ë“œ:**

```python
# backend/app/core/tracing.py
from phoenix.otel import register
from openinference.instrumentation.langchain import LangChainInstrumentor

def init_tracing() -> bool:
    """Phoenix íŠ¸ë ˆì´ì‹±ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."""
    if not settings.PHOENIX_ENABLED:
        return False
    
    tracer_provider = register(
        project_name=settings.PHOENIX_PROJECT_NAME,
        endpoint=settings.PHOENIX_COLLECTOR_ENDPOINT,
    )
    LangChainInstrumentor().instrument(tracer_provider=tracer_provider)
    return True
```

```yaml
# docker-compose.yml
services:
  phoenix:
    image: arizephoenix/phoenix:latest
    ports:
      - "6006:6006"  # Phoenix UI + OTLP HTTP
      - "4317:4317"  # OTLP gRPC
    environment:
      - PHOENIX_WORKING_DIR=/phoenix
    volumes:
      - phoenix_data:/phoenix
    restart: unless-stopped
```

**í™˜ê²½ë³€ìˆ˜:**

| ë³€ìˆ˜ | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|--------|------|
| `PHOENIX_COLLECTOR_ENDPOINT` | `http://localhost:6006/v1/traces` | Phoenix OTLP ìˆ˜ì§‘ ì—”ë“œí¬ì¸íŠ¸ |
| `PHOENIX_PROJECT_NAME` | `read-for-me` | Phoenix í”„ë¡œì íŠ¸ ì´ë¦„ |
| `PHOENIX_ENABLED` | `True` | íŠ¸ë ˆì´ì‹± í™œì„±í™” ì—¬ë¶€ |

**ì‚¬ìš©ë²•:**

```bash
# 1. Phoenix ì»¨í…Œì´ë„ˆ ì‹¤í–‰
docker compose up -d phoenix

# 2. ì˜ì¡´ì„± ì„¤ì¹˜
cd backend
uv sync

# 3. Backend ì„œë²„ ì‹¤í–‰ (.venv í´ë” watch ì œì™¸ ê¶Œì¥)
uv run uvicorn app.main:app --reload --reload-exclude ".venv"

# 4. Phoenix UI ì ‘ì†
open http://localhost:6006
```

**ë™ì‘ í™•ì¸ ë¡œê·¸:**

```
ğŸ”­ OpenTelemetry Tracing Details ğŸ”­
|  Phoenix Project: read-for-me
|  Span Processor: SimpleSpanProcessor
|  Collector Endpoint: http://localhost:6006/v1/traces
|  Transport: HTTP + protobuf

Phoenix íŠ¸ë ˆì´ì‹± ì´ˆê¸°í™” ì™„ë£Œ (project: read-for-me, endpoint: http://localhost:6006/v1/traces)
```

---

## ì„¤ê³„ ê²°ì • ê¸°ë¡ (ADR) - ì¶”ê°€

### ADR-027: Phoenix Docker ë¡œì»¬ ì„¤ì¹˜ ì„ íƒ

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ê²°ì •** | Phoenixë¥¼ Docker Composeë¡œ ë¡œì»¬ ì„¤ì¹˜ |
| **ì´ìœ ** | ê°œë°œ í™˜ê²½ì—ì„œ ë¹ ë¥¸ í”¼ë“œë°±, í´ë¼ìš°ë“œ ë¹„ìš© ì—†ìŒ, ë°ì´í„° í”„ë¼ì´ë²„ì‹œ ë³´ì¥ |
| **ëŒ€ì•ˆ** | 1) Arize Cloud (SaaS), 2) pip ì„¤ì¹˜ í›„ Python í”„ë¡œì„¸ìŠ¤ ë‚´ ì‹¤í–‰ |
| **ê²°ê³¼** | `docker compose up -d phoenix` í•œ ì¤„ë¡œ ì‹¤í–‰, ë³¼ë¥¨ìœ¼ë¡œ ë°ì´í„° ì˜ì†ì„± ë³´ì¥ |

### ADR-028: LangChain Instrumentation ëª…ì‹œì  ì„ íƒ

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ê²°ì •** | `auto_instrument=True` ëŒ€ì‹  `LangChainInstrumentor` ëª…ì‹œì  ì‚¬ìš© |
| **ì´ìœ ** | ì–´ë–¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ instrumentationë˜ëŠ”ì§€ ëª…í™•íˆ ì œì–´, ë¶ˆí•„ìš”í•œ ì˜¤ë²„í—¤ë“œ ë°©ì§€ |
| **ëŒ€ì•ˆ** | `register(auto_instrument=True)`ë¡œ ìë™ ê°ì§€ |
| **ê²°ê³¼** | LangChain í˜¸ì¶œë§Œ íŠ¸ë ˆì´ì‹±, ëª…ì‹œì  ì½”ë“œë¡œ ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ |

---

---

## Phase 8-1: GCS Storage ë§ˆì´ê·¸ë ˆì´ì…˜

### Storage ì¶”ìƒí™” ë ˆì´ì–´ êµ¬í˜„

- [x] `google-cloud-storage>=2.18.0` ì˜ì¡´ì„± ì¶”ê°€ (`pyproject.toml`)
- [x] Storage í™˜ê²½ë³€ìˆ˜ ì¶”ê°€ (`config.py`)
  - `STORAGE_BACKEND`: `"local"` | `"gcs"` (ê¸°ë³¸ê°’: `local`)
  - `GCS_BUCKET_NAME`: GCS ë²„í‚· ì´ë¦„ (ê¸°ë³¸ê°’: `read-for-me-data`)
  - `GCS_PROJECT_ID`: GCP í”„ë¡œì íŠ¸ ID (ê¸°ë³¸ê°’: `gen-lang-client-0039052673`)
  - `GCS_SIGNED_URL_EXPIRY_MINUTES`: Signed URL ë§Œë£Œ ì‹œê°„ (ê¸°ë³¸ê°’: `60`)
- [x] `StorageService` Protocol ë° êµ¬í˜„ì²´ ìƒì„± (`backend/app/services/storage.py`)
  - `LocalStorageService`: ë¡œì»¬ íŒŒì¼ì‹œìŠ¤í…œ ê¸°ë°˜
  - `GCSStorageService`: Google Cloud Storage ê¸°ë°˜
  - `get_storage_service()`: í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ íŒ©í† ë¦¬ í•¨ìˆ˜

### API ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •

- [x] `crawl.py`: `save_crawl_result()` â†’ StorageService ì‚¬ìš©
- [x] `summarize.py`: `_save_summary_result()` â†’ StorageService ì‚¬ìš©
- [x] `audio.py (API)`:
  - `_save_script_result()` â†’ StorageService ì‚¬ìš©
  - `_find_latest_script_json()` â†’ StorageService ì‚¬ìš© (async)
  - `get_audio_file()` â†’ GCSì¸ ê²½ìš° Signed URL 302 ë¦¬ë‹¤ì´ë ‰íŠ¸
- [x] `audio.py (service)`: `synthesize_speech()` â†’ StorageService ì‚¬ìš©

**ìƒì„±ëœ íŒŒì¼:**

| íŒŒì¼ | ì„¤ëª… |
|------|------|
| `backend/app/services/storage.py` | Storage ì¶”ìƒí™” ë ˆì´ì–´ (Protocol, Local, GCS) |

**ìˆ˜ì •ëœ íŒŒì¼:**

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|----------|
| `backend/pyproject.toml` | `google-cloud-storage>=2.18.0` ì˜ì¡´ì„± ì¶”ê°€ |
| `backend/app/core/config.py` | `STORAGE_BACKEND`, `GCS_*` í™˜ê²½ë³€ìˆ˜ 4ê°œ ì¶”ê°€ |
| `backend/app/api/v1/crawl.py` | `save_crawl_result()` StorageService ì‚¬ìš©, import ì •ë¦¬ |
| `backend/app/api/v1/summarize.py` | `_save_summary_result()` StorageService ì‚¬ìš©, import ì •ë¦¬ |
| `backend/app/api/v1/audio.py` | ì €ì¥/ì½ê¸°/ì„œë¹™ ë¡œì§ StorageServiceë¡œ êµì²´, Signed URL ë¦¬ë‹¤ì´ë ‰íŠ¸ |
| `backend/app/services/audio.py` | `synthesize_speech()` StorageServiceë¡œ êµì²´ |

**í•µì‹¬ êµ¬í˜„ ì½”ë“œ:**

```python
# backend/app/services/storage.py - StorageService Protocol
@runtime_checkable
class StorageService(Protocol):
    async def save_json(self, path: str, data: dict) -> str: ...
    async def load_json(self, path: str) -> dict | None: ...
    async def save_bytes(self, path: str, data: bytes, content_type: str) -> str: ...
    async def load_bytes(self, path: str) -> bytes | None: ...
    async def list_files(self, prefix: str, pattern: str) -> list[str]: ...
    async def get_download_url(self, path: str, expiry_minutes: int) -> str: ...
    def exists(self, path: str) -> bool: ...
    def get_local_path(self, path: str) -> Path | None: ...
```

```python
# backend/app/services/storage.py - íŒ©í† ë¦¬ í•¨ìˆ˜
def get_storage_service() -> StorageService:
    global _storage_service
    if _storage_service is None:
        backend = settings.STORAGE_BACKEND.lower()
        if backend == "gcs":
            _storage_service = GCSStorageService()
        else:
            _storage_service = LocalStorageService()
    return _storage_service
```

```python
# backend/app/api/v1/audio.py - GCS Signed URL ë¦¬ë‹¤ì´ë ‰íŠ¸
@router.get("/{article_id}.mp3")
async def get_audio_file(article_id: str, user_id: str = Query(default=DEFAULT_USER_ID)):
    storage = get_storage_service()
    audio_path = _get_audio_storage_path(user_id, article_id)

    if not storage.exists(audio_path):
        raise HTTPException(status_code=404, detail="ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

    # GCSì¸ ê²½ìš°: Signed URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    if isinstance(storage, GCSStorageService):
        signed_url = await storage.get_download_url(
            audio_path, expiry_minutes=settings.GCS_SIGNED_URL_EXPIRY_MINUTES
        )
        return RedirectResponse(url=signed_url, status_code=302)

    # Localì¸ ê²½ìš°: FileResponseë¡œ ì§ì ‘ ì„œë¹™
    local_path = storage.get_local_path(audio_path)
    return FileResponse(path=local_path, media_type="audio/mpeg")
```

**í™˜ê²½ë³€ìˆ˜:**

| ë³€ìˆ˜ | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|--------|------|
| `STORAGE_BACKEND` | `local` | ìŠ¤í† ë¦¬ì§€ ë°±ì—”ë“œ (`local` \| `gcs`) |
| `GCS_BUCKET_NAME` | `read-for-me-data` | GCS ë²„í‚· ì´ë¦„ |
| `GCS_PROJECT_ID` | `gen-lang-client-0039052673` | GCP í”„ë¡œì íŠ¸ ID |
| `GCS_SIGNED_URL_EXPIRY_MINUTES` | `60` | Signed URL ë§Œë£Œ ì‹œê°„ (ë¶„) |

**ì‚¬ìš©ë²•:**

```bash
# ë¡œì»¬ ê°œë°œ (ê¸°ë³¸ê°’)
STORAGE_BACKEND=local
# â†’ backend/data/ í´ë”ì— ì €ì¥

# í”„ë¡œë•ì…˜ (GCS)
STORAGE_BACKEND=gcs
GCS_BUCKET_NAME=read-for-me-data
GCS_PROJECT_ID=gen-lang-client-0039052673
# â†’ GCS ë²„í‚·ì— ì €ì¥, ì˜¤ë””ì˜¤ëŠ” Signed URLë¡œ ì„œë¹™
```

**GCS ê²½ë¡œ êµ¬ì¡°:**

```
gs://read-for-me-data/
â””â”€â”€ users/{user_id}/
    â”œâ”€â”€ crawled/{article_id}_{timestamp}.json
    â”œâ”€â”€ summary/{article_id}_{timestamp}.json
    â””â”€â”€ audio/
        â”œâ”€â”€ {article_id}_{timestamp}.json
        â””â”€â”€ {article_id}.mp3
```

---

## ì„¤ê³„ ê²°ì • ê¸°ë¡ (ADR) - ì¶”ê°€

### ADR-029: Storage ì¶”ìƒí™” ë ˆì´ì–´ ì„¤ê³„

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ê²°ì •** | Protocol ê¸°ë°˜ ì¶”ìƒí™” + íŒ©í† ë¦¬ íŒ¨í„´ìœ¼ë¡œ Local/GCS ì „í™˜ ê°€ëŠ¥ êµ¬ì¡° |
| **ì´ìœ ** | ë¡œì»¬ ê°œë°œê³¼ í”„ë¡œë•ì…˜ í™˜ê²½ì˜ ìœ ì—°í•œ ì „í™˜, í…ŒìŠ¤íŠ¸ ìš©ì´ì„± |
| **ëŒ€ì•ˆ** | 1) ì§ì ‘ ì¡°ê±´ë¬¸ ë¶„ê¸°, 2) ì¶”ìƒ í´ë˜ìŠ¤ ìƒì† |
| **ê²°ê³¼** | í™˜ê²½ë³€ìˆ˜ í•˜ë‚˜(`STORAGE_BACKEND`)ë¡œ ì „í™˜, ì½”ë“œ ë³€ê²½ ì—†ì´ ë°°í¬ í™˜ê²½ ì ìš© ê°€ëŠ¥ |

### ADR-030: GCS ì˜¤ë””ì˜¤ ì„œë¹™ Signed URL ì‚¬ìš©

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ê²°ì •** | GCS ì˜¤ë””ì˜¤ íŒŒì¼ì„ Signed URLë¡œ 302 ë¦¬ë‹¤ì´ë ‰íŠ¸ |
| **ì´ìœ ** | ë°±ì—”ë“œê°€ í”„ë¡ì‹œ ì—­í• ì„ í•˜ì§€ ì•Šì•„ ì„œë²„ ë¶€í•˜ ê°ì†Œ, CDN í™œìš© ê°€ëŠ¥ |
| **ëŒ€ì•ˆ** | 1) ë°±ì—”ë“œì—ì„œ ìŠ¤íŠ¸ë¦¬ë° í”„ë¡ì‹œ, 2) Public URL |
| **ê²°ê³¼** | í´ë¼ì´ì–¸íŠ¸ê°€ GCSì—ì„œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ, ë§Œë£Œ ì‹œê°„ìœ¼ë¡œ ë³´ì•ˆ ìœ ì§€ |

---

---

## Phase 8-2: í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ ğŸš€

### Cloud Run Backend ë°°í¬

- [x] Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Artifact Registry í‘¸ì‹œ
- [x] Cloud Run ì„œë¹„ìŠ¤ ìƒì„± (`read-for-me-backend`)
- [x] í™˜ê²½ë³€ìˆ˜ ì„¤ì • (CORS, Storage, Phoenix ë“±)
- [x] Secret Manager ì—°ë™ (`OPENAI_API_KEY`)
- [x] `min-instances=0` ë¹„ìš© ìµœì í™” ì„¤ì •

**ë°°í¬ URL:** https://read-for-me-backend-383521011372.asia-northeast3.run.app

**ì£¼ìš” í™˜ê²½ë³€ìˆ˜:**

| ë³€ìˆ˜ | ê°’ |
|------|-----|
| `STORAGE_BACKEND` | `gcs` |
| `GCS_BUCKET_NAME` | `read-for-me-data` |
| `PHOENIX_ENABLED` | `true` |
| `PHOENIX_COLLECTOR_ENDPOINT` | `https://phoenix-383521011372.asia-northeast3.run.app/v1/traces` |

### Phoenix Cloud Run ë°°í¬

- [x] Phoenix ì´ë¯¸ì§€ë¡œ Cloud Run ì„œë¹„ìŠ¤ ìƒì„±
- [x] Backendì™€ ì—°ë™ (PHOENIX_COLLECTOR_ENDPOINT)
- [x] `min-instances=0` ë¹„ìš© ìµœì í™” ì„¤ì •

**ë°°í¬ URL:** https://phoenix-383521011372.asia-northeast3.run.app

### Vercel Frontend ë°°í¬

- [x] Vercel CLIë¡œ í”„ë¡œë•ì…˜ ë°°í¬ (`vercel --prod`)
- [x] í™˜ê²½ë³€ìˆ˜ ì„¤ì • (`NEXT_PUBLIC_API_URL`)
- [x] Backend CORS ì„¤ì • ì—…ë°ì´íŠ¸

**ë°°í¬ URL:** https://read-for-me-ten.vercel.app

**ìˆ˜ì •ëœ íŒŒì¼:**

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|----------|
| `backend/Dockerfile` | Multi-stage build, Playwright í¬í•¨, Cloud Run ìµœì í™” |
| `backend/.dockerignore` | Docker ë¹Œë“œ ìµœì í™” |
| `backend/env.example` | í™˜ê²½ë³€ìˆ˜ í…œí”Œë¦¿ |
| `backend/app/main.py` | DEBUG_CORS í™˜ê²½ë³€ìˆ˜ ì œì–´ë¡œ ë³€ê²½ |
| `docker-compose.yml` | Backend ì„œë¹„ìŠ¤ ì¶”ê°€ (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©) |
| `docs/DEPLOY.md` | Cloud Run + Vercel ë°°í¬ ê°€ì´ë“œ |

**ë°°í¬ ëª…ë ¹ì–´ ì˜ˆì‹œ:**

```bash
# Backend ë°°í¬
gcloud run deploy read-for-me-backend \
    --image asia-northeast3-docker.pkg.dev/${PROJECT_ID}/read-for-me/backend:latest \
    --region asia-northeast3 \
    --allow-unauthenticated \
    --min-instances 0

# Phoenix ë°°í¬
gcloud run deploy phoenix \
    --image arizephoenix/phoenix:latest \
    --region asia-northeast3 \
    --allow-unauthenticated \
    --min-instances 0 \
    --port 6006

# Frontend ë°°í¬
cd frontend && vercel --prod
```

---

## ì„¤ê³„ ê²°ì • ê¸°ë¡ (ADR) - ì¶”ê°€

### ADR-031: Cloud Run min-instances=0 ì„¤ì •

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ê²°ì •** | ëª¨ë“  Cloud Run ì„œë¹„ìŠ¤ì— `min-instances=0` ì ìš© |
| **ì´ìœ ** | ë¹„ìš© ìµœì í™” (ìš”ì²­ ì—†ì„ ë•Œ ìë™ ì¢…ë£Œ), ê°œë°œ/í…ŒìŠ¤íŠ¸ ìš©ë„ì— ì í•© |
| **ëŒ€ì•ˆ** | `min-instances=1` (í•­ìƒ ì›œ ìƒíƒœ ìœ ì§€, cold start ì—†ìŒ) |
| **ê²°ê³¼** | ì›” ë¹„ìš© ê±°ì˜ ë¬´ë£Œ (ë¬´ë£Œ í‹°ì–´ ë‚´), ì²« ìš”ì²­ ì‹œ cold start 5-10ì´ˆ ë°œìƒ |

### ADR-032: Secret Managerë¡œ API í‚¤ ê´€ë¦¬

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ê²°ì •** | `OPENAI_API_KEY`ë¥¼ Secret Managerë¡œ ê´€ë¦¬ |
| **ì´ìœ ** | í™˜ê²½ë³€ìˆ˜ ë…¸ì¶œ ë°©ì§€, í‚¤ ë¡œí…Œì´ì…˜ ìš©ì´, Cloud Run í†µí•© ì§€ì› |
| **ëŒ€ì•ˆ** | í™˜ê²½ë³€ìˆ˜ ì§ì ‘ ì„¤ì •, ë³„ë„ í‚¤ ê´€ë¦¬ ì„œë¹„ìŠ¤ |
| **ê²°ê³¼** | `--set-secrets` í”Œë˜ê·¸ë¡œ ê°„í¸ ì—°ë™, ë³´ì•ˆ ê°•í™” |

---

## ë‹¤ìŒ ë‹¨ê³„

- [ ] **Phase 8-3: CI/CD Pipeline** - GitHub Actions ìë™ ë°°í¬
  - `dev` ë¸Œëœì¹˜ â†’ Staging í™˜ê²½
  - `main` ë¸Œëœì¹˜ â†’ Production í™˜ê²½
  - PR ì‹œ Lint + Type check + Test
- [ ] GitHub Secrets ì„¤ì • (`APIDOG_API_KEY`, `APIDOG_PROJECT_ID`)
- [ ] E2E í…ŒìŠ¤íŠ¸ ìë™í™”
- [ ] **Phase 6-3: LLM Evaluation Pipeline** - í‰ê°€ ë°ì´í„°ì…‹, LLM-as-Judge
- [ ] **Phase 6-5: Self-Improving Loop (DSPy ì—°ë™)**
  - Phoenix Tracing ë°ì´í„° â†’ DSPy í•™ìŠµì…‹ ë³€í™˜
  - MIPRO/GEPA ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ ìë™ ìµœì í™”
  - ì°¸ê³ : [ìŠ¤ìŠ¤ë¡œ ê°œì„ í•˜ëŠ” ì—ì´ì „íŠ¸](https://turingpost.co.kr/p/self-improving-agent-arize), [DSPy 3 + GEPA](https://medium.com/towards-artificial-intelligence/dspy-3-gepa-the-most-advanced-rag-framework-yet-auto-reasoning-prompting-f9124ebd975b)

