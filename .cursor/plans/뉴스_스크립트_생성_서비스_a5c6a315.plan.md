---
name: ë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì„œë¹„ìŠ¤
overview: Geminië¥¼ í™œìš©í•˜ì—¬ í¬ë¡¤ë§ëœ ì½˜í…ì¸ ë¥¼ 3ë¶„ ë¶„ëŸ‰ì˜ ë‰´ìŠ¤ ë¦¬í¬íŒ… ëŒ€ë³¸ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. AudioService ì „ìš© í™˜ê²½ë³€ìˆ˜ë¥¼ í†µí•´ SummaryServiceì™€ ë…ë¦½ì ìœ¼ë¡œ LLM ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
todos:
  - id: env-config
    content: config.py + .env - AudioServiceìš© í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¶”ê°€
    status: pending
  - id: output-schema
    content: output_schemas/audio.py - NewsScript Pydantic ëª¨ë¸ ì •ì˜
    status: pending
  - id: prompt-template
    content: prompts/v1/news_script.md - ë‰´ìŠ¤ ëŒ€ë³¸ ìƒì„± í”„ë¡¬í”„íŠ¸ ì‘ì„±
    status: pending
  - id: audio-service
    content: app/services/audio.py - AudioService í´ë˜ìŠ¤ êµ¬í˜„ (generate_script)
    status: pending
  - id: api-endpoint
    content: app/api/v1/audio.py - POST /api/v1/audio/script ì—”ë“œí¬ì¸íŠ¸
    status: pending
  - id: router-register
    content: app/main.py - audio ë¼ìš°í„° ë“±ë¡
    status: pending
---

# Step 1: ë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì„œë¹„ìŠ¤ êµ¬í˜„

## 1. ìš”êµ¬ì‚¬í•­ ë¶„ì„

### ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

- í¬ë¡¤ë§ëœ ì½˜í…ì¸ ë¥¼ **3ë¶„ ë¶„ëŸ‰**(ì•½ 900~1,050ì)ì˜ ë‰´ìŠ¤ ë¦¬í¬íŒ… ëŒ€ë³¸ìœ¼ë¡œ ë³€í™˜
- **ë‚¨ì„± ì•„ë‚˜ìš´ì„œ í†¤**ì˜ ë‰´ìŠ¤ ë¦¬í¬íŒ… ìŠ¤íƒ€ì¼
- OpenAI TTS API ê¸¸ì´ ì œí•œ ëŒ€ì‘ì„ ìœ„í•´ **ë¬¸ë‹¨ë³„ ë¶„ë¦¬** ì¶œë ¥ (`List[str]`)

### ì…ë ¥ ë°ì´í„°

- ìš”ì•½ ì„œë¹„ìŠ¤(`SummaryService`)ì™€ ë™ì¼í•œ ì…ë ¥ êµ¬ì¡°
- GeekNews: `content` + `original_content` ë³‘í•© ì‚¬ìš©

### ì¶œë ¥ ë°ì´í„° (êµ¬ì¡°í™”ëœ ê°ì²´)

```python
class NewsScript(BaseModel):
    paragraphs: list[str]        # ë¬¸ë‹¨ë³„ ìŠ¤í¬ë¦½íŠ¸ (8~12ê°œ, TTS ì²­í‚¹ìš©)
    title: str                   # ë‰´ìŠ¤ í—¤ë“œë¼ì¸
    estimated_duration_sec: int  # ì˜ˆìƒ ë¶„ëŸ‰ (ì´ˆ)
    total_characters: int        # ì´ ê¸€ì ìˆ˜
```

---

## 2. ì˜ì‚¬ê²°ì • ì‚¬í•­ (í™•ì •)

| í•­ëª© | ê²°ì • | ê·¼ê±° |

|------|------|------|

| ì…ë ¥ ì†ŒìŠ¤ | `content` + `original_content` ë³‘í•© | ìš”ì•½ ì„œë¹„ìŠ¤ì™€ ë™ì¼í•œ íŒ¨í„´ |

| ì¶œë ¥ í˜•ì‹ | êµ¬ì¡°í™”ëœ ê°ì²´ + ë¬¸ë‹¨ë³„ `List[str]` | TTS ì²­í‚¹ ë° silence padding ë³‘í•© ëŒ€ì‘ |

| ë¬¸ë‹¨ ìˆ˜ | 8~12ê°œ | 3ë¶„ / 15~20ì´ˆ/ë¬¸ë‹¨ = ì•½ 10ê°œ ë¬¸ë‹¨ |

| ë¬¸ë‹¨ë‹¹ ê¸€ì | 80~120ì | OpenAI TTS ê¶Œì¥ ì²­í¬ í¬ê¸° ë‚´ |

| LLM ì„¤ì • | í™˜ê²½ë³€ìˆ˜ë¡œ ë…ë¦½ ê´€ë¦¬ | SummaryServiceì™€ ë¶„ë¦¬ |---

## 3. í™˜ê²½ë³€ìˆ˜ ì„¤ì • (SummaryServiceì™€ ë¶„ë¦¬)

AudioService ì „ìš© í™˜ê²½ë³€ìˆ˜ë¥¼ ì •ì˜í•˜ì—¬ SummaryServiceì™€ ë…ë¦½ì ìœ¼ë¡œ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

### 3-1. `.env` íŒŒì¼ ì¶”ê°€ í•­ëª©

```bash
# ===========================================
# AudioService (ë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±) ì„¤ì •
# SummaryService ì„¤ì •ê³¼ ë³„ë„ë¡œ ê´€ë¦¬
# ===========================================
AUDIO_SCRIPT_MODEL=gemini-2.5-flash
AUDIO_SCRIPT_THINKING_LEVEL=low
AUDIO_SCRIPT_THINKING_BUDGET=2048
AUDIO_SCRIPT_INCLUDE_THOUGHTS=false
AUDIO_SCRIPT_TEMPERATURE=0.5
```



### 3-2. [`config.py`](backend/app/core/config.py) Settings í´ë˜ìŠ¤ ì¶”ê°€ í•„ë“œ

```python
class Settings(BaseSettings):
    # ... ê¸°ì¡´ ì„¤ì • ìœ ì§€ ...

    # Gemini Thinking ì„¤ì • (SummaryServiceìš©) - ê¸°ì¡´
    GEMINI_THINKING_LEVEL: str = "low"
    GEMINI_THINKING_BUDGET: int = 2048

    # ===== AudioService (ë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±) ì „ìš© ì„¤ì • - ì‹ ê·œ =====
    AUDIO_SCRIPT_MODEL: str = "gemini-2.5-flash"
    AUDIO_SCRIPT_THINKING_LEVEL: str = "low"
    AUDIO_SCRIPT_THINKING_BUDGET: int = 2048
    AUDIO_SCRIPT_INCLUDE_THOUGHTS: bool = False
    AUDIO_SCRIPT_TEMPERATURE: float = 0.5  # ëŒ€ë³¸ ìƒì„±ì€ ì•½ê°„ì˜ ì°½ì˜ì„± í—ˆìš©
```



### 3-3. AudioServiceì—ì„œ ì„¤ì • ì‚¬ìš© íŒ¨í„´

```python
# app/services/audio.py
from app.core.config import settings

class AudioService:
    def __init__(self):
        # settingsì—ì„œ AudioService ì „ìš© ì„¤ì • ë¡œë“œ
        self.model_name = settings.AUDIO_SCRIPT_MODEL
        self.thinking_level = settings.AUDIO_SCRIPT_THINKING_LEVEL
        self.thinking_budget = (
            settings.AUDIO_SCRIPT_THINKING_BUDGET 
            if self.thinking_level.lower() != "off" 
            else 0
        )
        self.include_thoughts = settings.AUDIO_SCRIPT_INCLUDE_THOUGHTS
        self.temperature = settings.AUDIO_SCRIPT_TEMPERATURE
        
        # LLM ì´ˆê¸°í™” (settings ê°’ ì‚¬ìš©)
        self.llm = ChatGoogleGenerativeAI(
            model=self.model_name,
            temperature=self.temperature,
            thinking_budget=self.thinking_budget,
            include_thoughts=self.include_thoughts,
            credentials=credentials,
            project=self.project_id,
        )
```

---

## 4. êµ¬í˜„ ê³„íš

### 4-1. Output Schema ì •ì˜

- íŒŒì¼: [`backend/output_schemas/audio.py`](backend/output_schemas/audio.py) (ì‹ ê·œ)
- `NewsScript` Pydantic ëª¨ë¸ ì •ì˜
- LangChain `with_structured_output()` í˜¸í™˜

### 4-2. í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì‘ì„±

- íŒŒì¼: [`backend/prompts/v1/news_script.md`](backend/prompts/v1/news_script.md) (ì‹ ê·œ)
- í•µì‹¬ ì§€ì‹œì‚¬í•­:
- 3ë¶„ ë¶„ëŸ‰ (ì´ 900~1,050ì)
- 8~12ê°œ ë¬¸ë‹¨ìœ¼ë¡œ ë¶„ë¦¬
- ë‚¨ì„± ë‰´ìŠ¤ ì•„ë‚˜ìš´ì„œ í†¤
- êµ¬ì–´ì²´ (ì²­ì·¨ì ì¹œí™”ì )
- ì›ë³¸ì— ì—†ëŠ” ë‚´ìš© ì¶”ê°€ ê¸ˆì§€

### 4-3. AudioService êµ¬í˜„ (Step 1ë§Œ)

- íŒŒì¼: [`backend/app/services/audio.py`](backend/app/services/audio.py) (ì‹ ê·œ)
- ê¸°ì¡´ `SummaryService` íŒ¨í„´ ì°¸ì¡°
- í•µì‹¬ ë©”ì„œë“œ:
```python
class AudioService:
    async def generate_script(
        self,
        content: str,
        original_content: str | None = None,
    ) -> NewsScript:
        """ì½˜í…ì¸ ë¥¼ ë‰´ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë³€í™˜"""
        ...
```




- í¬í•¨ ê¸°ëŠ¥:
- `_merge_content()`: content + original_content ë³‘í•© (SummaryService ë¡œì§ ì¬ì‚¬ìš©)
- tenacity ì¬ì‹œë„ ë¡œì§
- ë¡œê¹…

### 4-4. API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

- íŒŒì¼: [`backend/app/api/v1/audio.py`](backend/app/api/v1/audio.py) (ì‹ ê·œ)
- ì—”ë“œí¬ì¸íŠ¸: `POST /api/v1/audio/script`
```python
# Request
class GenerateScriptRequest(BaseModel):
    content: str
    original_content: str | None = None
    article_id: str | None = None
    user_id: str = "default"

# Response
class GenerateScriptResponse(BaseModel):
    user_id: str
    article_id: str
    script: NewsScript
    model: str
    processing_time_ms: int
```




### 4-5. ë¼ìš°í„° ë“±ë¡

- íŒŒì¼: [`backend/app/main.py`](backend/app/main.py)
- audio ë¼ìš°í„° ì¶”ê°€

---

## 5. íŒŒì¼ êµ¬ì¡° (ë³€ê²½ ì‚¬í•­)

```javascript
backend/
â”œâ”€â”€ .env                       # ğŸ”§ AUDIO_SCRIPT_* í™˜ê²½ë³€ìˆ˜ ì¶”ê°€
â”œâ”€â”€ app/core/
â”‚   â””â”€â”€ config.py              # ğŸ”§ AudioService ì„¤ì • í•„ë“œ ì¶”ê°€
â”œâ”€â”€ output_schemas/
â”‚   â”œâ”€â”€ summary.py             # ê¸°ì¡´
â”‚   â””â”€â”€ audio.py               # ğŸ†• NewsScript ìŠ¤í‚¤ë§ˆ
â”œâ”€â”€ prompts/v1/
â”‚   â”œâ”€â”€ summary.md             # ê¸°ì¡´
â”‚   â”œâ”€â”€ summary_stream.md      # ê¸°ì¡´
â”‚   â””â”€â”€ news_script.md         # ğŸ†• ë‰´ìŠ¤ ëŒ€ë³¸ í”„ë¡¬í”„íŠ¸
â””â”€â”€ app/
    â”œâ”€â”€ services/
    â”‚   â”œâ”€â”€ summary.py         # ê¸°ì¡´
    â”‚   â””â”€â”€ audio.py           # ğŸ†• AudioService
    â””â”€â”€ api/v1/
        â”œâ”€â”€ summarize.py       # ê¸°ì¡´
        â””â”€â”€ audio.py           # ğŸ†• audio ì—”ë“œí¬ì¸íŠ¸
```

---

## 6. ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
flowchart LR
    subgraph Config[í™˜ê²½ì„¤ì •]
        ENV[".env"]
        CFG["config.py"]
    end
    
    subgraph Input[ì…ë ¥]
        A[content]
        B[original_content]
    end
    
    subgraph AudioService[AudioService]
        C[_merge_content]
        D[generate_script]
        E["LLM: Gemini<br/>(settings ê¸°ë°˜)"]
    end
    
    subgraph Output[ì¶œë ¥]
        F[NewsScript]
        G["paragraphs: List[str]"]
        H[title, duration, chars]
    end
    
    ENV --> CFG
    CFG --> E
    A --> C
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    F --> H
```

---

## 7. í–¥í›„ Step 2 ì—°ë™ (ì°¸ê³ )

Step 1 ì™„ë£Œ í›„, Step 2(TTS)ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì—°ë™:

```python
# Step 2 ì˜ˆì‹œ (êµ¬í˜„ ì˜ˆì •)
async def synthesize_audio(script: NewsScript) -> bytes:
    audio_chunks = []
    for paragraph in script.paragraphs:
        chunk = await openai_tts(paragraph)
        audio_chunks.append(chunk)
    
    # silence padding + merge
    return merge_with_silence(audio_chunks, padding_ms=400)

```