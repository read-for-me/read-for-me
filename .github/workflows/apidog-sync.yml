# Apidog OpenAPI 스펙 자동 동기화 워크플로우
#
# 트리거:
# - main 브랜치 push 시 (backend/ 변경 감지)
# - 수동 실행 (workflow_dispatch)
#
# 필요한 GitHub Secrets:
# - APIDOG_API_KEY: Apidog API 키
# - APIDOG_PROJECT_ID: Apidog 프로젝트 ID

name: Sync OpenAPI to Apidog

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
  workflow_dispatch: # 수동 실행 허용

jobs:
  sync-openapi:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        working-directory: ./backend
        run: |
          uv sync

      - name: Generate OpenAPI spec
        working-directory: ./backend
        env:
          # 필수 환경 변수 (더미 값으로 앱 초기화만 수행)
          PROJECT_NAME: "Read-For-Me Backend"
          VERSION: "0.1.0"
          API_V1_STR: "/api/v1"
          BACKEND_CORS_ORIGINS: '["http://localhost:3000"]'
        run: |
          uv run python -c "
          import json
          from app.main import app

          openapi_schema = app.openapi()

          with open('../openapi.json', 'w', encoding='utf-8') as f:
              json.dump(openapi_schema, f, ensure_ascii=False, indent=2)

          print('OpenAPI spec generated successfully!')
          print(f'Endpoints: {len(openapi_schema.get(\"paths\", {}))}')
          "

      - name: Upload OpenAPI spec to Apidog
        continue-on-error: true
        env:
          APIDOG_API_KEY: ${{ secrets.APIDOG_API_KEY }}
          APIDOG_PROJECT_ID: ${{ secrets.APIDOG_PROJECT_ID }}
        run: |
          # OpenAPI 스펙을 Apidog 형식으로 래핑
          jq -n --slurpfile spec openapi.json '{"input": $spec[0]}' > apidog-payload.json

          curl -X POST "https://api.apidog.com/v1/projects/${APIDOG_PROJECT_ID}/import-openapi" \
            -H "Authorization: Bearer ${APIDOG_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @apidog-payload.json \
            --fail-with-body || echo "⚠️ Apidog sync failed (non-critical)"

      - name: Upload OpenAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.json
          retention-days: 30
